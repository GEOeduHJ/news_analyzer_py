# -*- coding: utf-8 -*-
"""news_bigkinds_analysis.ipynbì˜ ì‚¬ë³¸

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bO6JXhRmehlsWXMbnNzKjUnfMT9F-NlK
"""

!pip install konlpy wordcloud plotly networkx openpyxl -q
!apt-get -y install fonts-nanum > /dev/null
!fc-cache -fv > /dev/null

import matplotlib.pyplot as plt
from wordcloud import WordCloud
from collections import Counter
from konlpy.tag import Okt
import plotly.express as px
import plotly.graph_objects as go
import networkx as nx
import pandas as pd
import os

plt.rc('font', family='NanumGothic')  # í•œê¸€ í°íŠ¸ ì„¤ì •

"""# ë‰´ìŠ¤ê¸°ì‚¬ ë°ì´í„° ë‘˜ëŸ¬ë³´ê¸° :
1) ë¹…ì¹´ì¸ì¦ˆì—ì„œ ìˆ˜ì§‘í•œ ì´ 778ê°œì˜ ê¸°ì‚¬(2020~2025ë…„)ë³„ ë©”íƒ€ë°ì´í„°ê°€ ì •ë¦¬ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•¨.

2) ì—…ë¡œë“œí•œ ë°ì´í„°ê°€ ì •ë¦¬ëœ ì¸í„°ë™í‹°ë¸Œ í‘œë¥¼ í†µí•´ ê¸°ì‚¬ë¥¼ 1ì°¨ì ìœ¼ë¡œ íƒìƒ‰í•œë‹¤.
* í‘œ ë‚´ì—ì„œ ê²€ìƒ‰, ì •ë ¬ ë“±ì˜ ê¸°ëŠ¥ì„ í™œìš©í•  ìˆ˜ ìˆìŒ.
"""

# ë¹…ì¹´ì¸ì¦ˆë¡œ ë‹¤ìš´ë°›ì€ ë‰´ìŠ¤ê¸°ì‚¬ ëª©ë¡íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•˜ê¸°(xlsx íŒŒì¼)

from google.colab import files
uploaded = files.upload()  # "Bigkinds_news_result.xlsx" íŒŒì¼ ì—…ë¡œë“œ
df = pd.read_excel(next(iter(uploaded)))

from IPython.display import HTML
import pandas as pd

def render_mini_datatable(df, max_rows=100):
    # âœ… ì—´ ì„ íƒ ë° í•œê¸€ ì—´ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
    selected_columns = ["ì¼ì", "ì œëª©", "ê¸°ê´€", "íŠ¹ì„±ì¶”ì¶œ(ê°€ì¤‘ì¹˜ìˆœ ìƒìœ„ 50ê°œ)", "URL"]
    rename_map = {
        "ì¼ì": "ì‘ì„±/ê²Œì‹œì¼ì",
        "ì œëª©": "ê¸°ì‚¬ì œëª©",
        "ê¸°ê´€": "ê´€ë ¨ê¸°ê´€",
        "íŠ¹ì„±ì¶”ì¶œ(ê°€ì¤‘ì¹˜ìˆœ ìƒìœ„ 50ê°œ)": "í‚¤ì›Œë“œ(ê°€ì¤‘ì¹˜ìˆœ ìƒìœ„ 50ê°œ)",
        "URL": "ê¸°ì‚¬ë§í¬"
    }

    df_display = df[selected_columns].rename(columns=rename_map)

    html = df_display.to_html(classes='table table-striped table-bordered', escape=False)

    return HTML(f'''
    <style>
        table.dataTable {{
            table-layout: auto !important;
            width: auto !important;
            word-break: break-word;
            white-space: normal;
        }}
        th, td {{
            padding: 8px !important;
            text-align: left !important;
            vertical-align: top;
            max-width: 400px;
            white-space: normal !important;
        }}
    </style>
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script>
    $(document).ready(function() {{
        $('table').DataTable({{
            "pageLength": 50,
            "autoWidth": false
        }});
    }});
    </script>
    {html}
    ''')

# âœ… ì‹¤í–‰
render_mini_datatable(df)

"""# ë¶„ì„ 1. ì—°ë„ë³„ ê¸°ì‚¬ëŸ‰ íŠ¸ë Œë“œ ë¶„ì„
ê¸°ì‚¬ë³„ ì‘ì„±ì¼ ë˜ëŠ” ê²Œì‹œì¼ì„ ê¸°ì¤€ìœ¼ë¡œ, ì—°ë„ë³„ ê¸°ì‚¬ëŸ‰ì„ ì¸í„°ë™í‹°ë¸Œ ë§‰ëŒ€ê·¸ë˜í”„ë¡œ ì‹œê°í™”í•˜ì—¬ ë¶„ì„í•¨.
"""

# ë¶„ì„ 1. ì—°ë„ë³„ ê¸°ì‚¬ëŸ‰ ë¶„ì„

df["ì—°ë„"] = df["ì¼ì"].astype(str).str[:4]
year_counts = df["ì—°ë„"].value_counts().sort_index()

fig1 = px.bar(
    x=year_counts.index,
    y=year_counts.values,
    labels={"x": "ì—°ë„", "y": "ê¸°ì‚¬ ìˆ˜"},
    title="ì—°ë„ë³„ ê¸°ì‚¬ ìˆ˜ ë¶„ì„"
)
fig1.show()

"""# ë¶„ì„ 2. ì—°ê´€í‚¤ì›Œë“œ ì›Œë“œí´ë¼ìš°ë“œ ë¶„ì„
ë‰´ìŠ¤ ê¸°ì‚¬ì—ì„œ "í‚¤ì›Œë“œ"ë¡œ ë¶„ë¥˜ëœ ë‹¨ì–´ë“¤ì„ ì›Œë“œí´ë¼ìš°ë“œë¡œ ë‚˜íƒ€ë‚´ì–´ ë¶„ì„í•¨.
* í‚¤ì›Œë“œëŠ” ë³¸ë¬¸ ë‚´ì—ì„œ ì¶”ì¶œëœ í‚¤ì›Œë“œ ì¤‘ ë‹¨ìˆœ ìˆ«ì(1, 2, 2018, 2019 ë“±), ì´ë©”ì¼ ì£¼ì†Œ, ì‹œê°„ì„ ëœ»í•˜ëŠ” ë‹¨ì–´(ë°¤, ë‚®, ìƒˆë²½ ë“±)ë¥¼ ì œì™¸í•œ ê²°ê³¼ê°€ í‘œì‹œë¨.
"""

# ë¶„ì„ 2. ì—°ê´€í‚¤ì›Œë“œ ì›Œë“œí´ë¼ìš°ë“œ ë¶„ì„

import warnings
warnings.filterwarnings("ignore")  # âš ï¸ ëª¨ë“  ê²½ê³  ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°

from wordcloud import WordCloud
import matplotlib.pyplot as plt
from collections import Counter

# í‚¤ì›Œë“œ ì²˜ë¦¬
all_keywords = ",".join(df["í‚¤ì›Œë“œ"].dropna().astype(str)).split(",")
filtered_keywords = [kw.strip() for kw in all_keywords if len(kw.strip()) > 1]
keyword_freq = Counter(filtered_keywords)
top_keywords = dict(keyword_freq.most_common(100))

# ì›Œë“œí´ë¼ìš°ë“œ ìƒì„±
wc = WordCloud(
    font_path="/usr/share/fonts/truetype/nanum/NanumGothic.ttf",  # ì„¤ì¹˜ëœ ë‚˜ëˆ”ê³ ë”• ê²½ë¡œ
    background_color="white",
    width=800,
    height=400
).generate_from_frequencies(top_keywords)

# PNG íŒŒì¼ë¡œ ì €ì¥
wc.to_file("wordcloud_output.png")

# ì´ë¯¸ì§€ ì¶œë ¥
plt.figure(figsize=(12, 6))
plt.imshow(wc, interpolation="bilinear")
plt.axis("off")
plt.title("")
plt.show()

"""# ë¶„ì„ 3. ì´í•´ê´€ê³„ë„ ë„¤íŠ¸ì›Œí¬ ë¶„ì„
ë‰´ìŠ¤ ê¸°ì‚¬ì— ë“±ì¥í•œ ì—¬ëŸ¬ ê¸°ê´€ ê°„ì˜ ë„¤íŠ¸ì›Œí¬ë¥¼ ì¸í„°ë™í‹°ë¸Œ ì´í•´ê´€ê³„ë„ë¡œ ì‹œê°í™”í•˜ì—¬ ë¶„ì„í•¨.
* ëª¨ë“  ê¸°ê´€ì´ ì•„ë‹Œ, ìƒìœ„ 20ê°œì˜ ê¸°ê´€ë§Œì„ ë‚˜íƒ€ëƒ„.
"""

from collections import Counter
import networkx as nx
import plotly.graph_objects as go

# 1. ê¸°ê´€ ê°„ ë™ì‹œì¶œí˜„ ê´€ê³„ ì¶”ì¶œ
co_occurrence = Counter()
for row in df["ê¸°ê´€"].dropna():
    orgs = list(set([o.strip() for o in str(row).split(",") if len(o.strip()) > 1]))
    for i in range(len(orgs)):
        for j in range(i+1, len(orgs)):
            edge = tuple(sorted([orgs[i], orgs[j]]))
            co_occurrence[edge] += 1

# 2. ë™ì‹œì¶œí˜„ 5íšŒ ì´ìƒë§Œ í•„í„°ë§
filtered_edges = {pair: w for pair, w in co_occurrence.items() if w >= 5}

G = nx.Graph()
for (a, b), weight in filtered_edges.items():
    G.add_edge(a, b, weight=weight)

# 3. ì—°ê²° ìˆ˜ ê¸°ì¤€ ìƒìœ„ 20ê°œ ë…¸ë“œë§Œ ì‚¬ìš©
# ìƒìœ„ í‚¤ì›Œë“œ ìˆ˜ ì§ì ‘ ì¡°ì ˆí•  ìˆ˜ ìˆë„ë¡ í•˜ë©´ ë” ì¢‹ì„ í…ë°...
top_nodes = sorted(G.degree, key=lambda x: x[1], reverse=True)[:20]
G_filtered = G.subgraph([n for n, _ in top_nodes])

# 4. ë…¸ë“œ ìœ„ì¹˜ ê³„ì‚°
pos = nx.spring_layout(G_filtered, seed=42)

# 5. ì—£ì§€ ì¢Œí‘œ ì¶”ì¶œ
edge_x, edge_y = [], []
for edge in G_filtered.edges():
    x0, y0 = pos[edge[0]]
    x1, y1 = pos[edge[1]]
    edge_x += [x0, x1, None]
    edge_y += [y0, y1, None]

edge_trace = go.Scatter(
    x=edge_x, y=edge_y,
    line=dict(width=0.5, color="#aaa"),
    hoverinfo='none',
    mode='lines'
)
# 6. ë…¸ë“œ ì¢Œí‘œ ë° ì •ë³´
node_x, node_y, node_text = [], [], []
node_sizes = []
node_colors = []

for node in G_filtered.nodes():
    x, y = pos[node]
    degree = G_filtered.degree[node]
    node_x.append(x)
    node_y.append(y)
    node_text.append(f"{node} (ì—°ê²° ìˆ˜: {degree})")

    # ğŸ”¥ ì—°ê²° ìˆ˜ì— ë”°ë¼ ë¯¼ê°í•˜ê²Œ ë°˜ì‘í•˜ë„ë¡ í¬ê¸° ì¡°ì •
    size = 3 + (degree ** 1.6)  # ë˜ëŠ” np.log(degree + 1) * 15 ë„ ê°€ëŠ¥
    node_sizes.append(size)
    node_colors.append(degree)

node_trace = go.Scatter(
    x=node_x, y=node_y,
    mode='markers+text',
    text=[n for n in G_filtered.nodes()],
    textposition='top center',
    marker=dict(
        size=node_sizes,
        color=node_colors,
        colorscale='YlGnBu',
        showscale=True,
        colorbar=dict(title='ì—°ê²° ìˆ˜')
    ),
    hovertext=node_text,
    hoverinfo='text'
)

# 7. ìµœì¢… ê·¸ë˜í”„ ì‹œê°í™”
fig2 = go.Figure(data=[edge_trace, node_trace],
    layout=go.Layout(
        title="ê¸°ê´€ ê°„ í•µì‹¬ ë„¤íŠ¸ì›Œí¬ ê´€ê³„ë„ (Top 20)",
        showlegend=False,
        hovermode='closest',
        xaxis=dict(showgrid=False, zeroline=False, showticklabels=False),
        yaxis=dict(showgrid=False, zeroline=False, showticklabels=False)
    )
)
fig2.show()